<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard</title>

  <style>
    .container { max-width: 1000px; margin: 20px auto; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f0f0f0; }
    ul { margin: 0; padding-left: 20px; list-style: none; }
    form { margin: 0; }
  </style>
</head>
<body>

<audio id="newOrderSound">
  <source src="/static/sound.mp3" type="audio/mpeg">
</audio>

<div class="container">
  <h1>Admin Dashboard</h1>
  <p><a href="{{ url_for('admin_logout') }}">Logout</a></p>

  {% if orders %}
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Qty Ã— Price</th>
          <th>Total Price</th>
          <th>Status</th>
          <th>Placed</th>
          <th>Location</th>
          <th>Update Status</th>
        </tr>
      </thead>
      <tbody>

        {% for o in orders %}
        <tr>

          <td>{{ o.order_id }}</td>

          <td>
            {{ o.customer_name }}<br>
            {{ o.phone }}<br>
            {{ o.email }}
          </td>

          <!-- ITEM NAMES -->
          <td>
            <ul>
              {% for item in o.items %}
                <li>{{ item.item_name }}</li>
              {% endfor %}
            </ul>
          </td>

          <!-- SUBTOTAL PER ITEM -->
          <td>
            <ul>
              {% for item in o.items %}
                {% set q = item.quantity|int %}
                {% set p = item.price|float %}
                {% set subtotal = q * p %}
                <li>{{ q }} Ã— â‚¹{{ "%.2f"|format(p) }} = â‚¹{{ "%.2f"|format(subtotal) }}</li>
              {% endfor %}
            </ul>
          </td>

          <!-- FINAL TOTAL PRICE (BACKEND CALCULATION) -->
          <td><strong>â‚¹{{ "%.2f"|format(o.total_price()) }}</strong></td>

          <td>{{ o.status }}</td>
          <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

          <!-- LOCATION -->
          <td>
            {% if o.latitude and o.longitude %}
              <a href="https://www.google.com/maps?q={{ o.latitude }},{{ o.longitude }}" target="_blank">View Map</a>
            {% else %}
              N/A
            {% endif %}
          </td>

          <!-- UPDATE STATUS -->
          <td>
            <form method="POST" action="{{ url_for('update_status', order_db_id=o.id) }}">
              <select name="status">
                {% for s in ['Pending','Accepted','Processing','ontheway','Completed','Cancelled'] %}
                  <option value="{{ s }}" {% if o.status == s %}selected{% endif %}>{{ s|capitalize }}</option>
                {% endfor %}
              </select>
              <button type="submit">Update</button>
            </form>
          </td>

        </tr>
        {% endfor %}

      </tbody>
    </table>

  {% else %}
    <p>No orders yet.</p>
  {% endif %}
</div>

<script>
function checkOrders() {
    fetch('/check-new-orders')
        .then(r => r.json())
        .then(data => {
            if (data.new) {
                document.getElementById("newOrderSound").play();
                alert("ðŸ”” New Order Arrived!");
                location.reload();
            }
        });
}
setInterval(checkOrders, 5000);
</script>

</body>
</html>
