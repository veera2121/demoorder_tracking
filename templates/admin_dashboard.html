<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard</title>

  <style>
    .container { max-width: 1100px; margin: 20px auto; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    .filters { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .filters input, .filters select { padding: 8px; font-size: 14px; }
    .pagination { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
    .pagination a { padding: 6px 12px; background: #eee; border: 1px solid #ccc; text-decoration: none; }
  </style>
</head>
<body>

<audio id="newOrderSound">
  <source src="/static/sound.mp3" type="audio/mpeg">
</audio>

<div class="container">
  <h1>Admin Dashboard</h1>

  <p><a href="{{ url_for('admin_logout') }}">Logout</a></p>

  <!-- FILTER BAR -->
  <form method="GET" action="" class="filters">
    <input type="text" name="query" placeholder="Search orders"
           value="{{ query }}">

    <select name="status">
      <option value="">All Status</option>
      {% for s in ['Pending','Accepted','Processing','ontheway','Completed','Cancelled'] %}
        <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>

    <input type="date" name="start_date" value="{{ start_date }}">
    <input type="date" name="end_date" value="{{ end_date }}">

    <button type="submit">Apply</button>
  </form>

  {% if orders %}
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Qty Ã— Price</th>
          <th>Total Price</th>
          <th>Status</th>
          <th>Placed</th>
          <th>Location</th>
          <th>Update Status</th>
        </tr>
      </thead>
      <tbody>

        {% for o in orders %}
        <tr>

          <td>{{ o.order_id }}</td>

          <td>
            {{ o.customer_name }}<br>
            {{ o.phone }}<br>
            {{ o.email }}
          </td>

          <td>
            <ul>
              {% for item in o.items %}
                <li>{{ item.item_name }}</li>
              {% endfor %}
            </ul>
          </td>

          <td>
            <ul>
              {% for item in o.items %}
                {% set q = item.quantity|int %}
                {% set p = item.price|float %}
                {% set subtotal = q * p %}
                <li>{{ q }} Ã— â‚¹{{ "%.2f"|format(p) }} = â‚¹{{ "%.2f"|format(subtotal) }}</li>
              {% endfor %}
            </ul>
          </td>

          <td><strong>â‚¹{{ "%.2f"|format(o.total_price()) }}</strong></td>

          <td>{{ o.status }}</td>

          <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

          <td>
            {% if o.latitude and o.longitude %}
              <a href="https://www.google.com/maps?q={{ o.latitude }},{{ o.longitude }}" target="_blank">Map</a>
            {% else %}
              N/A
            {% endif %}
          </td>

          <td>
            <form method="POST" action="{{ url_for('update_status', order_db_id=o.id) }}">
              <select name="status">
                {% for s in ['Pending','Accepted','Processing','ontheway','Completed','Cancelled'] %}
                  <option value="{{ s }}" {% if o.status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
              <button type="submit">Update</button>
            </form>
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="pagination">
      {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}&query={{ query }}&status={{ status_filter }}&start_date={{ start_date }}&end_date={{ end_date }}">â¬… Prev</a>
      {% endif %}

      {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}&query={{ query }}&status={{ status_filter }}&start_date={{ start_date }}&end_date={{ end_date }}">Next âž¡</a>
      {% endif %}
    </div>

  {% else %}
    <p>No orders found.</p>
  {% endif %}
</div>

<script>
function checkOrders() {
    fetch('/check-new-orders')
        .then(r => r.json())
        .then(data => {
            if (data.new) {
                document.getElementById("newOrderSound").play();
                alert("ðŸ”” New Order Arrived!");
                location.reload();
            }
        });
}
setInterval(checkOrders, 5000);
</script>

</body>
</html>
